events { worker_connections 1024; }
http {
    include /etc/nginx/mime.types;
    upstream backend { server backend:8001; }
    upstream frontend { server frontend:80; }
    
    # Map to detect social media crawlers
    map $http_user_agent $is_crawler {
        default 0;
        ~*(facebookexternalhit|Facebot|Twitterbot|Pinterest|LinkedInBot|WhatsApp|TelegramBot|Slackbot|Discordbot|vkShare|redditbot|Applebot|Googlebot|bingbot) 1;
    }
    
    server {
        listen 80;
        client_max_body_size 50M;
        
        # API routes - always go to backend
        location /api/ { 
            proxy_pass http://backend; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Health check
        location /health { 
            proxy_pass http://backend; 
        }
        
        # OG meta tag endpoint for crawlers (direct access)
        location /og/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Gallery pages with /g/ prefix - route crawlers to OG endpoint
        location ~ ^/g/([^/]+)$ {
            set $share_link $1;
            
            # If it's a crawler, serve OG meta tags from backend
            if ($is_crawler) {
                rewrite ^/g/(.+)$ /og/g/$1 break;
                proxy_pass http://backend;
            }
            
            # For regular users, serve the React app
            proxy_pass http://frontend;
            proxy_set_header Host $host;
        }
        
        # Gallery pages with /gallery/ prefix - route crawlers to OG endpoint
        location ~ ^/gallery/([^/]+)$ {
            set $share_link $1;
            
            # If it's a crawler, serve OG meta tags from backend
            if ($is_crawler) {
                rewrite ^/gallery/(.+)$ /og/gallery/$1 break;
                proxy_pass http://backend;
            }
            
            # For regular users, serve the React app
            proxy_pass http://frontend;
            proxy_set_header Host $host;
        }
        
        # All other routes - serve React app
        location / { 
            proxy_pass http://frontend; 
            proxy_set_header Host $host; 
        }
    }
}
